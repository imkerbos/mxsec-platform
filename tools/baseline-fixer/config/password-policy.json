{
  "id": "LINUX_PASSWORD_POLICY",
  "name": "密码策略基线",
  "version": "2.0.0",
  "description": "系统密码策略检查（参考 CIS Benchmark 和等保 2.0）",
  "os_family": ["rocky", "centos", "oracle", "debian", "ubuntu", "almalinux"],
  "os_version": ">=7",
  "enabled": true,
  "rules": [
    {
      "rule_id": "LINUX_PASS_001",
      "category": "password",
      "title": "密码最大有效期",
      "description": "密码最大有效期应不超过 90 天（等保 2.0 要求）",
      "severity": "medium",
      "check": {
        "condition": "all",
        "rules": [
          {
            "type": "file_exists",
            "param": ["/etc/login.defs"]
          },
          {
            "type": "file_kv",
            "param": ["/etc/login.defs", "PASS_MAX_DAYS", "^([1-8]?[0-9]|90)$"]
          }
        ]
      },
      "fix": {
        "suggestion": "修改 /etc/login.defs，设置 PASS_MAX_DAYS 90 或更小",
        "command": "sed -i 's/^PASS_MAX_DAYS.*/PASS_MAX_DAYS 90/' /etc/login.defs"
      }
    },
    {
      "rule_id": "LINUX_PASS_002",
      "category": "password",
      "title": "密码最小长度",
      "description": "密码最小长度应至少为 8 位（等保 2.0 要求）",
      "severity": "medium",
      "check": {
        "condition": "all",
        "rules": [
          {
            "type": "file_exists",
            "param": ["/etc/login.defs"]
          },
          {
            "type": "file_kv",
            "param": ["/etc/login.defs", "PASS_MIN_LEN", "^([8-9]|[1-9][0-9]+)$"]
          }
        ]
      },
      "fix": {
        "suggestion": "修改 /etc/login.defs，设置 PASS_MIN_LEN 8 或更大",
        "command": "sed -i 's/^PASS_MIN_LEN.*/PASS_MIN_LEN 8/' /etc/login.defs"
      }
    },
    {
      "rule_id": "LINUX_PASS_003",
      "category": "password",
      "title": "密码最小使用天数",
      "description": "密码最小使用天数应至少为 1 天，防止频繁更换密码绕过历史限制",
      "severity": "low",
      "check": {
        "condition": "all",
        "rules": [
          {
            "type": "file_exists",
            "param": ["/etc/login.defs"]
          },
          {
            "type": "file_kv",
            "param": ["/etc/login.defs", "PASS_MIN_DAYS", "^[1-9][0-9]*$"]
          }
        ]
      },
      "fix": {
        "suggestion": "修改 /etc/login.defs，设置 PASS_MIN_DAYS 1 或更大",
        "command": "sed -i 's/^PASS_MIN_DAYS.*/PASS_MIN_DAYS 1/' /etc/login.defs"
      }
    },
    {
      "rule_id": "LINUX_PASS_004",
      "category": "password",
      "title": "密码过期警告天数",
      "description": "密码过期前应提前 7 天警告用户",
      "severity": "low",
      "check": {
        "condition": "all",
        "rules": [
          {
            "type": "file_exists",
            "param": ["/etc/login.defs"]
          },
          {
            "type": "file_kv",
            "param": ["/etc/login.defs", "PASS_WARN_AGE", "^[7-9]|[1-9][0-9]+$"]
          }
        ]
      },
      "fix": {
        "suggestion": "修改 /etc/login.defs，设置 PASS_WARN_AGE 7 或更大",
        "command": "sed -i 's/^PASS_WARN_AGE.*/PASS_WARN_AGE 7/' /etc/login.defs"
      }
    },
    {
      "rule_id": "LINUX_PASS_005",
      "category": "password",
      "title": "PAM 密码复杂度 - 最小长度",
      "description": "PAM 密码复杂度模块应配置最小长度 8",
      "severity": "high",
      "check": {
        "condition": "any",
        "rules": [
          {
            "type": "file_line_match",
            "param": ["/etc/security/pwquality.conf", "^\\s*minlen\\s*=\\s*([8-9]|[1-9][0-9]+)", "match"]
          },
          {
            "type": "file_line_match",
            "param": ["/etc/pam.d/system-auth", "pam_pwquality\\.so.*minlen=([8-9]|[1-9][0-9]+)", "match"]
          }
        ]
      },
      "fix": {
        "suggestion": "配置 /etc/security/pwquality.conf，设置 minlen = 8",
        "command": "sed -i 's/^#*\\s*minlen.*/minlen = 8/' /etc/security/pwquality.conf"
      }
    },
    {
      "rule_id": "LINUX_PASS_006",
      "category": "password",
      "title": "PAM 密码复杂度 - 数字要求",
      "description": "密码应至少包含 1 个数字",
      "severity": "medium",
      "check": {
        "condition": "any",
        "rules": [
          {
            "type": "file_line_match",
            "param": ["/etc/security/pwquality.conf", "^\\s*dcredit\\s*=\\s*-[1-9]", "match"]
          },
          {
            "type": "file_line_match",
            "param": ["/etc/pam.d/system-auth", "pam_pwquality\\.so.*dcredit=-[1-9]", "match"]
          }
        ]
      },
      "fix": {
        "suggestion": "配置 /etc/security/pwquality.conf，设置 dcredit = -1",
        "command": "sed -i 's/^#*\\s*dcredit.*/dcredit = -1/' /etc/security/pwquality.conf"
      }
    },
    {
      "rule_id": "LINUX_PASS_007",
      "category": "password",
      "title": "PAM 密码复杂度 - 大写字母要求",
      "description": "密码应至少包含 1 个大写字母",
      "severity": "medium",
      "check": {
        "condition": "any",
        "rules": [
          {
            "type": "file_line_match",
            "param": ["/etc/security/pwquality.conf", "^\\s*ucredit\\s*=\\s*-[1-9]", "match"]
          },
          {
            "type": "file_line_match",
            "param": ["/etc/pam.d/system-auth", "pam_pwquality\\.so.*ucredit=-[1-9]", "match"]
          }
        ]
      },
      "fix": {
        "suggestion": "配置 /etc/security/pwquality.conf，设置 ucredit = -1",
        "command": "sed -i 's/^#*\\s*ucredit.*/ucredit = -1/' /etc/security/pwquality.conf"
      }
    },
    {
      "rule_id": "LINUX_PASS_008",
      "category": "password",
      "title": "PAM 密码复杂度 - 小写字母要求",
      "description": "密码应至少包含 1 个小写字母",
      "severity": "medium",
      "check": {
        "condition": "any",
        "rules": [
          {
            "type": "file_line_match",
            "param": ["/etc/security/pwquality.conf", "^\\s*lcredit\\s*=\\s*-[1-9]", "match"]
          },
          {
            "type": "file_line_match",
            "param": ["/etc/pam.d/system-auth", "pam_pwquality\\.so.*lcredit=-[1-9]", "match"]
          }
        ]
      },
      "fix": {
        "suggestion": "配置 /etc/security/pwquality.conf，设置 lcredit = -1",
        "command": "sed -i 's/^#*\\s*lcredit.*/lcredit = -1/' /etc/security/pwquality.conf"
      }
    },
    {
      "rule_id": "LINUX_PASS_009",
      "category": "password",
      "title": "PAM 密码复杂度 - 特殊字符要求",
      "description": "密码应至少包含 1 个特殊字符",
      "severity": "medium",
      "check": {
        "condition": "any",
        "rules": [
          {
            "type": "file_line_match",
            "param": ["/etc/security/pwquality.conf", "^\\s*ocredit\\s*=\\s*-[1-9]", "match"]
          },
          {
            "type": "file_line_match",
            "param": ["/etc/pam.d/system-auth", "pam_pwquality\\.so.*ocredit=-[1-9]", "match"]
          }
        ]
      },
      "fix": {
        "suggestion": "配置 /etc/security/pwquality.conf，设置 ocredit = -1",
        "command": "sed -i 's/^#*\\s*ocredit.*/ocredit = -1/' /etc/security/pwquality.conf"
      }
    },
    {
      "rule_id": "LINUX_PASS_010",
      "category": "password",
      "title": "PAM 密码历史记录",
      "description": "应记录最近 5 个密码，防止重复使用",
      "severity": "medium",
      "check": {
        "condition": "any",
        "rules": [
          {
            "type": "file_line_match",
            "param": ["/etc/pam.d/system-auth", "pam_unix\\.so.*remember=([5-9]|[1-9][0-9]+)", "match"]
          },
          {
            "type": "file_line_match",
            "param": ["/etc/pam.d/password-auth", "pam_unix\\.so.*remember=([5-9]|[1-9][0-9]+)", "match"]
          }
        ]
      },
      "fix": {
        "suggestion": "修改 /etc/pam.d/system-auth，在 pam_unix.so 行添加 remember=5",
        "command": "sed -i 's/pam_unix.so$/pam_unix.so remember=5/' /etc/pam.d/system-auth"
      }
    },
    {
      "rule_id": "LINUX_PASS_011",
      "category": "password",
      "title": "账户登录失败锁定",
      "description": "连续登录失败 5 次后应锁定账户",
      "severity": "high",
      "check": {
        "condition": "any",
        "rules": [
          {
            "type": "file_line_match",
            "param": ["/etc/pam.d/system-auth", "pam_faillock\\.so.*deny=([1-5])", "match"]
          },
          {
            "type": "file_line_match",
            "param": ["/etc/pam.d/password-auth", "pam_faillock\\.so.*deny=([1-5])", "match"]
          },
          {
            "type": "file_line_match",
            "param": ["/etc/security/faillock.conf", "^\\s*deny\\s*=\\s*([1-5])", "match"]
          }
        ]
      },
      "fix": {
        "suggestion": "配置 PAM faillock 模块，设置 deny=5",
        "command": "echo 'deny = 5' >> /etc/security/faillock.conf"
      }
    },
    {
      "rule_id": "LINUX_PASS_012",
      "category": "password",
      "title": "账户锁定时间",
      "description": "账户锁定后应至少锁定 15 分钟（900秒）",
      "severity": "medium",
      "check": {
        "condition": "any",
        "rules": [
          {
            "type": "file_line_match",
            "param": ["/etc/pam.d/system-auth", "pam_faillock\\.so.*unlock_time=([9][0-9]{2,}|[1-9][0-9]{3,})", "match"]
          },
          {
            "type": "file_line_match",
            "param": ["/etc/security/faillock.conf", "^\\s*unlock_time\\s*=\\s*([9][0-9]{2,}|[1-9][0-9]{3,})", "match"]
          }
        ]
      },
      "fix": {
        "suggestion": "配置 PAM faillock 模块，设置 unlock_time=900",
        "command": "echo 'unlock_time = 900' >> /etc/security/faillock.conf"
      }
    },
    {
      "rule_id": "LINUX_PASS_013",
      "category": "password",
      "title": "加密算法 SHA512",
      "description": "密码应使用 SHA512 算法加密存储",
      "severity": "high",
      "check": {
        "condition": "all",
        "rules": [
          {
            "type": "file_exists",
            "param": ["/etc/login.defs"]
          },
          {
            "type": "file_kv",
            "param": ["/etc/login.defs", "ENCRYPT_METHOD", "SHA512"]
          }
        ]
      },
      "fix": {
        "suggestion": "修改 /etc/login.defs，设置 ENCRYPT_METHOD SHA512",
        "command": "sed -i 's/^ENCRYPT_METHOD.*/ENCRYPT_METHOD SHA512/' /etc/login.defs"
      }
    },
    {
      "rule_id": "LINUX_PASS_014",
      "category": "password",
      "title": "禁止使用用户名作为密码",
      "description": "密码不应包含用户名",
      "severity": "medium",
      "check": {
        "condition": "any",
        "rules": [
          {
            "type": "file_line_match",
            "param": ["/etc/security/pwquality.conf", "^\\s*usercheck\\s*=\\s*1", "match"]
          },
          {
            "type": "file_line_match",
            "param": ["/etc/security/pwquality.conf", "^\\s*usersubstr\\s*=\\s*[1-9]", "match"]
          }
        ]
      },
      "fix": {
        "suggestion": "配置 /etc/security/pwquality.conf，设置 usercheck = 1",
        "command": "echo 'usercheck = 1' >> /etc/security/pwquality.conf"
      }
    },
    {
      "rule_id": "LINUX_PASS_015",
      "category": "password",
      "title": "限制连续相同字符",
      "description": "密码中连续相同字符不应超过 3 个",
      "severity": "low",
      "check": {
        "condition": "all",
        "rules": [
          {
            "type": "file_line_match",
            "param": ["/etc/security/pwquality.conf", "^\\s*maxrepeat\\s*=\\s*[0-3]$", "match"]
          }
        ]
      },
      "fix": {
        "suggestion": "配置 /etc/security/pwquality.conf，设置 maxrepeat = 3",
        "command": "echo 'maxrepeat = 3' >> /etc/security/pwquality.conf"
      }
    }
  ]
}
