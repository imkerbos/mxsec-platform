---
alwaysApply: true
---
# Matrix Cloud Security Platform · Cursor 规则文件 

# 目标：
# - 帮助在 Cursor 中使用本仓库时，先统一上下文、再做开发。
# - 约束：先读 Elkeid 的 baseline & agent 实现，抽象出自己的设计，而不是直接复制。

------------------------------------------------------------------------

## 1. 项目定位

-   项目名称：Matrix Cloud Security Platform（矩阵云安全平台）
-   目标：
    -   v1：实现 Linux 操作系统基线检查平台（Agent + Server + UI）。
    -   v2：扩展中间件（Nginx / Redis / MySQL 等）、容器 / K8s 基线。
-   设计理念：
    -   轻量：只做"基线安全"，不做全家桶 HIDS。
    -   可扩展：策略模型与检查器可插拔。
    -   可维护：适配新系统版本（Rocky9 / Debian12 等）要简单。

------------------------------------------------------------------------

## 2. 技术栈约定

### 2.1 后端 / Server

-   语言：Golang（\>=1.21，建议与当前工作环境一致）。
-   框架建议：
    -   Web：Gin / Fiber（二选一，优先使用现有习惯）。
    -   ORM：Gorm。
    -   配置：Viper。
    -   日志：Zap（结构化日志，JSON 输出）。
-   存储：
    -   配置 & 结果：MySQL / PostgreSQL。
    -   日志 / 指标：对接现有 ELK / Loki /
        Prometheus，不作为本项目核心范畴。

### 2.2 Agent

-   语言：Golang。
-   形式：
    -   单二进制，部署为 systemd service。
    -   支持 aarch64 / x86_64。
-   配置方式：
    -   **完全依赖构建时嵌入**：Server 地址等关键配置通过 `-ldflags` 嵌入到二进制。
    -   **无需配置文件**：安装后即可运行，简化部署。
    -   **证书由 Server 下发**：首次连接时自动下载证书。
    -   **日志默认配置**：`/var/log/mxsec-agent/agent.log`，按天轮转，保留30天。
-   能力：
    -   采集主机信息（OS、内核、软件包、服务等）。
    -   拉取 / 接收策略。
    -   执行基线检查 & 上报结果。

### 2.3 前端 / UI

-   技术栈：
    -   Vue3 + TypeScript。
    -   状态管理：Pinia。
    -   组件库：Ant Design Vue / Naive UI（二选一）。
-   页面优先级：
    1.  主机列表 + 基线得分。
    2.  主机详情 + 规则列表。
    3.  策略列表 + 编辑。
    4.  策略详情 + 检查项视角（检查概览、规则列表、影响的主机列表）。
    5.  扫描任务管理。

------------------------------------------------------------------------

## 3. Cursor 使用工作流

> 在 Cursor 中打开本仓库时，**默认遵守以下工作方式**。

1.  **始终先阅读：**
    -   本文件：`.cursor/rules/common.mdc`
    -   项目根目录的 `README.md`
2.  **任何开发任务开始前：**
    -   明确当前任务类型（需求分析 / 设计 / 编码 / 重构 / 排错）。
    -   在当前对话开头写出一个 Todo 列表，例如：

``` text
当前任务：实现 SSH 基线检查器
TODO:
[ ] 整理 SSH 相关基线规则模型
[ ] 设计 go 接口（Check(ctx, rule)）
[ ] 实现 /etc/ssh/sshd_config 解析
[ ] 编写单元测试
[ ] 接入 Agent 主流程
```

-   做完一个子任务就把勾打上，保持开发节奏可视化。

3.  **与 Elkeid 相关的操作：**
    -   任何引用 Elkeid
        实现细节时，先说明"仅借鉴设计思想，不直接拷贝代码"。
    -   对于解释 Elkeid 行为，优先用文字描述 /
        画流程，不复制整块源代码。
4.  **生成代码前：**
    -   先让 AI / 自己简单写出"接口 / 数据结构草图"，再生成完整实现。
    -   尽量保持每次生成的代码块围绕一个小目标，方便 review 和重构。

------------------------------------------------------------------------

## 4. Elkeid 学习路线（给 AI / 自己的提示）

> 目标：系统理解 Elkeid 的基线与 Agent 设计，为本项目设计提供参考。

### 4.1 文档与架构

-   阅读 Elkeid 官方 README 与架构说明，关注：
    -   Agent / Driver / RASP / Baseline / HUB 之间的关系。
    -   Agent 插件列表及各自职责（尤其是 baseline 插件）。
-   阅读官方 Agent 文档中关于：
    -   Agent 的能力：数据通信、组件版本控制、文件传输等。
    -   与 Server（AgentCenter、ServiceDiscovery）的 gRPC + mTLS
        双向通信模型。
    -   插件如何以"子进程 + pipes + protobuf"的方式与 Agent 通信。

### 4.2 Agent 源码关注点

-   定位 Agent 主入口：
    -   关注配置加载、服务注册、健康检查。
-   理解插件框架：
    -   插件进程如何启动、停止、重启；
    -   如何将插件数据封装为 protobuf 并透传至 Server；
    -   如何管理插件版本与配置。

### 4.3 Baseline 插件关注点

-   配置模型：
    -   规则如何按 OS / 版本 / 资产类型分类；
    -   规则包含哪些字段（ID、描述、严重级别、期望值、修复建议等）。
-   检查执行：
    -   支持哪些检查方式（命令执行、文件匹配、sysctl、服务状态等）；
    -   如何统一封装检查结果（pass / fail / warn / na）。
-   输出数据结构：
    -   一条基线结果的字段；
    -   一次扫描任务的整体结果结构。

### 4.4 设计对标

-   梳理与 Elkeid 不同的设计点：
    -   轻量化 / 部署复杂度；
    -   新系统版本适配方式；
    -   与现有 CMDB / 告警系统 / 日志系统的集成方式。

------------------------------------------------------------------------

## 5. Agent 配置设计原则

### 5.1 配置方式

-   **完全构建时嵌入**：所有关键配置（Server 地址、版本信息）通过 `-ldflags` 嵌入到二进制。
-   **无需配置文件**：Agent 安装后即可运行，简化部署流程。
-   **证书由 Server 下发**：首次连接时自动下载证书到 `/var/lib/mxsec-agent/certs/`。
-   **配置更新**：运行时配置（心跳间隔、工作目录等）由 Server 通过 gRPC 下发。

### 5.2 日志配置

-   **默认路径**：`/var/log/mxsec-agent/agent.log`
-   **轮转方式**：按天轮转（每天生成新文件：`agent.log.YYYY-MM-DD`）
-   **保留时间**：30天自动清理
-   **日志格式**：JSON（结构化日志）

### 5.3 构建示例

```bash
# Server 端构建 Agent
SERVER_HOST="10.0.0.1:6751"
VERSION="1.0.0"

go build -ldflags "\
    -X main.serverHost=$SERVER_HOST \
    -X main.buildVersion=$VERSION \
    -X main.buildTime=$(date -u +"%Y-%m-%dT%H:%M:%SZ")" \
    -o mxsec-agent ./cmd/agent
```

### 5.4 目录结构

-   `/var/lib/mxsec-agent/`：数据目录（Agent ID、证书）
-   `/var/log/mxsec-agent/`：日志目录（标准 Linux 日志目录）

------------------------------------------------------------------------

## 6. Baseline 策略模型设计原则（草案）

> 这部分在实现时可拆到 `docs/design/baseline_policy.md`。

1.  **策略集 \> 规则：**
    -   一个"策略集（policy）"包含多条"规则（rule）"；
    -   按 OS / 业务 / 合规要求划分不同策略集。
2.  **规则字段建议：**

``` yaml
id: "LINUX_SSH_001"
category: "ssh"
title: "禁止 root 远程登录"
description: "sshd_config 中应设置 PermitRootLogin no"
os_family: ["rocky", "centos", "oracle"]
os_version: ">=7"
severity: "high"          # low/medium/high/critical
check:
  type: "file_kv"         # command / sysctl / file_kv / service / package 等
  path: "/etc/ssh/sshd_config"
  key: "PermitRootLogin"
  expected: "no"
fix:
  suggestion: "修改 sshd_config 并重启 sshd"
```

3.  **扩展性：**

-   所有 check 类型都通过统一接口：`Check(ctx, rule) (Result, error)`\
-   可以很容易新增中间件基线（Nginx / Redis / MySQL 等）。

------------------------------------------------------------------------

## 7. 代码组织规范

### 7.1 main.go 保持简洁

-   **原则**：`main.go` 只负责启动流程（调用初始化包、设置路由/服务、启动服务、信号处理），不包含初始化逻辑和业务逻辑。
-   **Manager**：
    -   `cmd/server/manager/main.go`：启动流程（约 60 行）
    -   `internal/server/manager/setup/`：所有初始化逻辑（配置加载、日志、数据库、业务服务等）
    -   `internal/server/manager/router/`：所有 HTTP 路由配置
    -   `internal/server/manager/middleware/`：HTTP 中间件
-   **AgentCenter**：
    -   `cmd/server/agentcenter/main.go`：启动流程（约 50 行）
    -   `internal/server/agentcenter/setup/`：所有初始化逻辑（配置加载、日志、数据库、gRPC Server 等）
    -   `internal/server/agentcenter/server/`：gRPC Server 创建和配置
    -   `internal/server/agentcenter/scheduler/`：任务调度器

### 7.2 模块化设计

-   路由、中间件、服务创建等逻辑提取到独立的包中
-   每个包职责单一，便于测试和维护
-   遵循 Go 包命名规范：小写字母，简短有意义

### 7.3 编译隔离

-   Agent、AgentCenter、Manager 独立编译，不会相互包含代码
-   每个组件只包含自己需要的依赖
-   使用 `go build ./cmd/agent` 等命令独立编译

---

## 8. 编码规范（简要）

> 详细分支 / commit 规范已在其他文档中，这里只写本项目的关键约束。

### 8.1 Go 代码

-   禁止在业务逻辑中使用 `panic`；出现严重错误用错误返回链处理。
-   日志：
    -   使用 Zap，统一结构化日志；
    -   必须带上下文字段（`host_id`、`rule_id`、`task_id` 等）。
-   配置：
    -   **Agent**：完全依赖构建时嵌入，Server 地址必须通过 `-ldflags` 嵌入。
    -   **Server**：使用 Viper + YAML 配置文件管理。
    -   所有硬编码配置（端口、数据库连接、超时时间）都要抽到配置文件。
-   测试：
    -   基线检查器必须有单元测试，覆盖：
        -   正常 pass；
        -   fail；
        -   not_applicable 场景。

### 8.2 Vue / TS 代码

-   使用 Composition API。
-   API 调用封装在 `src/api` 目录，禁止在组件中硬编码 URL。
-   表格页面必须支持：
    -   分页；
    -   简单筛选（按主机、按策略、按状态）；
    -   导出按钮预留。

------------------------------------------------------------------------

## 9. Git 分支 & Commit（本仓库简化版）

### 9.1 分支工作流

-   **默认分支**：`main` 分支是项目的默认分支，包含稳定、可部署的代码。
-   **开发流程**：
    1.  开发新功能或修复问题时，从 `main` 分支创建新的功能分支。
    2.  在功能分支上完成开发和测试。
    3.  确认代码没问题后，合并到 `main` 分支。
-   **分支命名规范**：
    -   `feat/baseline-ssh-check` - 新功能
    -   `feat/agent-heartbeat` - 新功能
    -   `fix/server-crash-when-no-policy` - 缺陷修复
    -   `docs/update-readme` - 文档更新
    -   `chore/update-dependencies` - 其他维护性工作

### 9.2 Commit 规范

-   Commit 前缀（参考 conventional commits 简化）：
    -   `feat:` 新功能；
    -   `fix:` 修复；
    -   `refactor:` 重构；
    -   `docs:` 文档；
    -   `chore:` 其他。

------------------------------------------------------------------------

## 10. 调试与日志查看规范

> **重要**：本项目使用 Docker 容器部署，所有日志都在容器内，调试时必须查看容器日志，而不是宿主机文件系统。

### 10.1 查看容器日志（必须）

**调试时，始终使用以下命令查看容器日志，而不是在宿主机文件系统中查找日志文件。**

#### 开发环境（docker-compose.dev.yml）

```bash
# 查看所有服务日志（实时跟踪）
make dev-docker-logs
# 或
cd deploy/docker-compose && docker-compose -f docker-compose.dev.yml logs -f

# 查看特定服务日志
docker-compose -f deploy/docker-compose/docker-compose.dev.yml logs -f manager
docker-compose -f deploy/docker-compose/docker-compose.dev.yml logs -f agentcenter
docker-compose -f deploy/docker-compose/docker-compose.dev.yml logs -f ui

# 查看最近100行日志
docker-compose -f deploy/docker-compose/docker-compose.dev.yml logs --tail=100 manager

# 直接查看容器日志（容器名称）
docker logs -f mxsec-manager-dev
docker logs -f mxsec-agentcenter-dev
docker logs -f mxsec-ui-dev
```

#### 生产环境（docker-compose.yml）

```bash
# 查看所有服务日志
make docker-logs
# 或
cd deploy/docker-compose && docker-compose logs -f

# 查看特定服务日志
docker-compose -f deploy/docker-compose/docker-compose.yml logs -f manager
docker-compose -f deploy/docker-compose/docker-compose.yml logs -f agentcenter

# 直接查看容器日志（容器名称）
docker logs -f mxcsec-manager
docker logs -f mxcsec-agentcenter
docker logs -f mxcsec-ui
```

### 10.2 容器名称对照表

| 服务 | 开发环境容器名 | 生产环境容器名 |
|------|---------------|---------------|
| Manager | `mxsec-manager-dev` | `mxcsec-manager` |
| AgentCenter | `mxsec-agentcenter-dev` | `mxcsec-agentcenter` |
| UI | `mxsec-ui-dev` | `mxcsec-ui` |
| Agent | `mxcsec-agent-test` | `mxcsec-agent-test` |
| MySQL | `mxsec-mysql` | `mxsec-mysql` |

### 10.3 进入容器调试

```bash
# 进入 Manager 容器
docker exec -it mxsec-manager-dev sh
# 或生产环境
docker exec -it mxcsec-manager sh

# 在容器内查看日志文件（如果配置了文件日志）
ls -la /var/log/mxcsec-platform/
cat /var/log/mxcsec-platform/manager.log

# 查看进程
ps aux | grep manager
```

### 10.4 常见调试场景

1. **API 500 错误**：
   ```bash
   # 查看 Manager 容器日志，查找错误堆栈
   docker logs -f mxsec-manager-dev | grep -i error
   ```

2. **数据库连接问题**：
   ```bash
   # 查看 Manager 和 AgentCenter 日志
   docker logs mxsec-manager-dev | grep -i "database\|mysql\|connection"
   ```

3. **前端构建错误**：
   ```bash
   # 查看 UI 容器日志
   docker logs -f mxsec-ui-dev
   ```

4. **Agent 连接问题**：
   ```bash
   # 查看 AgentCenter 和 Agent 日志
   docker logs -f mxsec-agentcenter-dev
   docker logs -f mxcsec-agent-test
   ```

### 10.5 注意事项

- **不要**在宿主机文件系统中查找日志文件（如 `./logs/`、`/var/log/` 等），日志都在容器内。
- **不要**假设日志文件在项目根目录，所有服务都在容器内运行。
- 如果需要在容器内查看日志文件，先进入容器：`docker exec -it <container_name> sh`
- 日志通常输出到容器的标准输出（stdout/stderr），使用 `docker logs` 即可查看。

------------------------------------------------------------------------

## 11. 未来扩展提示

当 v1 OS 基线稳定后，扩展方向可以按以下顺序考虑：

1.  **中间件基线：**
    -   Nginx、Redis、MySQL、Kafka 等。
2.  **K8s & 容器基线：**
    -   节点配置、Pod 安全策略（如 seccomp、capabilities、runAsNonRoot
        等）。
3.  **与 HIDS / Runtime Security 联动：**
    -   如结合 eBPF / Falco / Elkeid Driver 等运行时数据，形成"基线 +
        行为"双维度视图。
