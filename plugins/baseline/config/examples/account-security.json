{
  "id": "LINUX_ACCOUNT_SECURITY",
  "name": "账户安全基线",
  "version": "1.0.0",
  "description": "系统账户安全检查（参考 CIS Benchmark 和等保 2.0）",
  "os_family": ["rocky", "centos", "oracle", "debian", "ubuntu", "almalinux"],
  "os_version": ">=7",
  "enabled": true,
  "rules": [
    {
      "rule_id": "LINUX_ACCOUNT_001",
      "category": "account",
      "title": "root 账户 UID 为 0",
      "description": "root 账户的 UID 必须为 0",
      "severity": "critical",
      "check": {
        "condition": "all",
        "rules": [
          {
            "type": "file_line_match",
            "param": ["/etc/passwd", "^root:x:0:0:", "match"]
          }
        ]
      },
      "fix": {
        "suggestion": "确保 /etc/passwd 中 root 账户的 UID 为 0"
      }
    },
    {
      "rule_id": "LINUX_ACCOUNT_002",
      "category": "account",
      "title": "无其他 UID 为 0 的账户",
      "description": "除 root 外不应存在 UID 为 0 的账户",
      "severity": "critical",
      "check": {
        "condition": "all",
        "rules": [
          {
            "type": "command_exec",
            "param": ["awk -F: '($3 == 0 && $1 != \"root\") { print $1 }' /etc/passwd | wc -l", "^0$"]
          }
        ]
      },
      "fix": {
        "suggestion": "删除或修改除 root 外 UID 为 0 的账户"
      }
    },
    {
      "rule_id": "LINUX_ACCOUNT_003",
      "category": "account",
      "title": "root 账户登录超时",
      "description": "root 账户应配置登录超时（TMOUT）",
      "severity": "medium",
      "check": {
        "condition": "any",
        "rules": [
          {
            "type": "file_line_match",
            "param": ["/etc/profile", "^\\s*TMOUT=", "match"]
          },
          {
            "type": "file_line_match",
            "param": ["/etc/bashrc", "^\\s*TMOUT=", "match"]
          },
          {
            "type": "file_line_match",
            "param": ["/etc/profile.d/timeout.sh", "^\\s*TMOUT=", "match"]
          }
        ]
      },
      "fix": {
        "suggestion": "在 /etc/profile 中添加 TMOUT=300 并 export TMOUT",
        "command": "echo 'TMOUT=300' >> /etc/profile && echo 'export TMOUT' >> /etc/profile"
      }
    },
    {
      "rule_id": "LINUX_ACCOUNT_004",
      "category": "account",
      "title": "禁用系统账户登录",
      "description": "系统账户（UID < 1000）的 shell 应为 /sbin/nologin 或 /bin/false",
      "severity": "medium",
      "check": {
        "condition": "all",
        "rules": [
          {
            "type": "command_exec",
            "param": ["awk -F: '($3 < 1000 && $1 != \"root\" && $7 !~ /nologin|false|sync|shutdown|halt/) { print $1 }' /etc/passwd | wc -l", "^0$"]
          }
        ]
      },
      "fix": {
        "suggestion": "将系统账户的 shell 设置为 /sbin/nologin",
        "command": "for user in $(awk -F: '($3 < 1000 && $1 != \"root\" && $7 !~ /nologin|false/) { print $1 }' /etc/passwd); do usermod -s /sbin/nologin $user; done"
      }
    },
    {
      "rule_id": "LINUX_ACCOUNT_005",
      "category": "account",
      "title": "所有账户都有密码",
      "description": "所有可登录账户都应设置密码",
      "severity": "high",
      "check": {
        "condition": "all",
        "rules": [
          {
            "type": "command_exec",
            "param": ["awk -F: '($2 == \"\" || $2 == \"!\") { print $1 }' /etc/shadow 2>/dev/null | wc -l", "^0$"]
          }
        ]
      },
      "fix": {
        "suggestion": "为空密码账户设置密码或锁定账户"
      }
    },
    {
      "rule_id": "LINUX_ACCOUNT_006",
      "category": "account",
      "title": "默认 umask 设置",
      "description": "默认 umask 应设置为 027 或更严格",
      "severity": "medium",
      "check": {
        "condition": "any",
        "rules": [
          {
            "type": "file_line_match",
            "param": ["/etc/profile", "^\\s*umask\\s+0?[0-2]7$", "match"]
          },
          {
            "type": "file_line_match",
            "param": ["/etc/bashrc", "^\\s*umask\\s+0?[0-2]7$", "match"]
          },
          {
            "type": "file_line_match",
            "param": ["/etc/login.defs", "^\\s*UMASK\\s+0?[0-2]7$", "match"]
          }
        ]
      },
      "fix": {
        "suggestion": "在 /etc/profile 或 /etc/login.defs 中设置 umask 027",
        "command": "sed -i 's/^umask.*/umask 027/' /etc/profile /etc/bashrc"
      }
    },
    {
      "rule_id": "LINUX_ACCOUNT_007",
      "category": "account",
      "title": "禁止 root 从控制台以外登录",
      "description": "/etc/securetty 应限制 root 登录终端",
      "severity": "medium",
      "check": {
        "condition": "all",
        "rules": [
          {
            "type": "file_exists",
            "param": ["/etc/securetty"]
          }
        ]
      },
      "fix": {
        "suggestion": "创建或配置 /etc/securetty 文件，限制 root 登录终端"
      }
    },
    {
      "rule_id": "LINUX_ACCOUNT_008",
      "category": "account",
      "title": "禁用 guest 账户",
      "description": "系统不应存在 guest 账户",
      "severity": "medium",
      "check": {
        "condition": "all",
        "rules": [
          {
            "type": "file_line_match",
            "param": ["/etc/passwd", "^guest:", "not_match"]
          }
        ]
      },
      "fix": {
        "suggestion": "删除 guest 账户：userdel guest",
        "command": "userdel guest 2>/dev/null || true"
      }
    },
    {
      "rule_id": "LINUX_ACCOUNT_009",
      "category": "account",
      "title": "用户主目录存在",
      "description": "所有用户的主目录应存在",
      "severity": "low",
      "check": {
        "condition": "all",
        "rules": [
          {
            "type": "command_exec",
            "param": ["awk -F: '($3 >= 1000 && $6 != \"\" && $6 != \"/dev/null\") { system(\"test -d \" $6 \" || echo \" $1) }' /etc/passwd | wc -l", "^0$"]
          }
        ]
      },
      "fix": {
        "suggestion": "为用户创建缺失的主目录"
      }
    },
    {
      "rule_id": "LINUX_ACCOUNT_010",
      "category": "account",
      "title": "用户主目录权限",
      "description": "用户主目录权限不应超过 750",
      "severity": "medium",
      "check": {
        "condition": "all",
        "rules": [
          {
            "type": "command_exec",
            "param": ["find /home -maxdepth 1 -type d -perm /027 2>/dev/null | wc -l", "^[01]$"]
          }
        ]
      },
      "fix": {
        "suggestion": "修改用户主目录权限为 750 或更严格",
        "command": "chmod 750 /home/*"
      }
    },
    {
      "rule_id": "LINUX_ACCOUNT_011",
      "category": "account",
      "title": "无重复 UID",
      "description": "系统中不应存在重复的 UID",
      "severity": "high",
      "check": {
        "condition": "all",
        "rules": [
          {
            "type": "command_exec",
            "param": ["awk -F: '{print $3}' /etc/passwd | sort | uniq -d | wc -l", "^0$"]
          }
        ]
      },
      "fix": {
        "suggestion": "修改重复的 UID"
      }
    },
    {
      "rule_id": "LINUX_ACCOUNT_012",
      "category": "account",
      "title": "无重复 GID",
      "description": "系统中不应存在重复的 GID",
      "severity": "medium",
      "check": {
        "condition": "all",
        "rules": [
          {
            "type": "command_exec",
            "param": ["awk -F: '{print $3}' /etc/group | sort | uniq -d | wc -l", "^0$"]
          }
        ]
      },
      "fix": {
        "suggestion": "修改重复的 GID"
      }
    },
    {
      "rule_id": "LINUX_ACCOUNT_013",
      "category": "account",
      "title": "无重复用户名",
      "description": "系统中不应存在重复的用户名",
      "severity": "high",
      "check": {
        "condition": "all",
        "rules": [
          {
            "type": "command_exec",
            "param": ["awk -F: '{print $1}' /etc/passwd | sort | uniq -d | wc -l", "^0$"]
          }
        ]
      },
      "fix": {
        "suggestion": "修改重复的用户名"
      }
    },
    {
      "rule_id": "LINUX_ACCOUNT_014",
      "category": "account",
      "title": "无重复组名",
      "description": "系统中不应存在重复的组名",
      "severity": "medium",
      "check": {
        "condition": "all",
        "rules": [
          {
            "type": "command_exec",
            "param": ["awk -F: '{print $1}' /etc/group | sort | uniq -d | wc -l", "^0$"]
          }
        ]
      },
      "fix": {
        "suggestion": "修改重复的组名"
      }
    },
    {
      "rule_id": "LINUX_ACCOUNT_015",
      "category": "account",
      "title": "wheel 组 sudo 权限",
      "description": "sudo 权限应通过 wheel 组管理",
      "severity": "medium",
      "check": {
        "condition": "any",
        "rules": [
          {
            "type": "file_line_match",
            "param": ["/etc/sudoers", "^%wheel\\s+ALL=\\(ALL\\)", "match"]
          },
          {
            "type": "file_line_match",
            "param": ["/etc/sudoers.d/wheel", "^%wheel\\s+ALL=\\(ALL\\)", "match"]
          }
        ]
      },
      "fix": {
        "suggestion": "配置 wheel 组的 sudo 权限"
      }
    }
  ]
}
