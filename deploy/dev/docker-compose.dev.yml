version: '3.8'

# 开发环境 Docker Compose 配置
# 使用方式: docker-compose -f docker-compose.dev.yml up
# 注意：使用宿主机现有的 MySQL（127.0.0.1:3306, root/123456）

services:
  agentcenter:
    build:
      context: ../..
      dockerfile: deploy/docker/Dockerfile.agentcenter.dev
    container_name: mxsec-agentcenter-dev
    restart: unless-stopped
    ports:
      - "6751:6751"
    volumes:
      # 挂载源代码，支持热重载（需要重新编译）
      - ../../:/workspace:rw
      # 挂载配置文件
      - ./configs/server.dev.yaml:/etc/mxsec-platform/server.yaml:ro
      # 挂载证书
      - ./certs:/etc/mxsec-platform/certs:ro
      - agentcenter_logs:/var/log/mxsec-platform
      # Go 模块缓存
      - go_mod_cache:/go/pkg/mod
      - go_build_cache:/root/.cache/go-build
    working_dir: /workspace
    environment:
      - TZ=Asia/Shanghai
      - GO_ENV=development
    # 访问宿主机 MySQL 使用 host.docker.internal（macOS/Windows）或 172.17.0.1（Linux）
    extra_hosts:
      - "host.docker.internal:host-gateway"
    # 开发模式：优先使用 Air（如果可用），否则使用 go run
    command: >
      sh -c "
        cd /workspace && 
        # 确保 tmp 目录存在
        mkdir -p tmp &&
        # 先运行 go mod tidy 确保依赖正确
        go mod tidy &&
        if command -v air > /dev/null 2>&1 && [ -f .air.agentcenter.toml ]; then
          echo '使用 Air 热重载模式（AgentCenter）...';
          air -c .air.agentcenter.toml
        else
          echo '使用 go run 模式（修改代码后需要手动重启容器）...';
          go run ./cmd/server/agentcenter -config /etc/mxsec-platform/server.yaml
        fi
      "
    networks:
      - mxsec-network
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 6751 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 120s

  manager:
    build:
      context: ../..
      dockerfile: deploy/docker/Dockerfile.manager.dev
    container_name: mxsec-manager-dev
    restart: unless-stopped
    # macOS Docker Desktop 不支持 host 网络模式，使用端口映射
    # 访问宿主机 MySQL 使用 host.docker.internal（macOS/Windows）或 172.17.0.1（Linux）
    ports:
      - "8080:8080"
    volumes:
      # 挂载源代码，支持热重载（需要重新编译）
      - ../../:/workspace:rw
      # 挂载配置文件
      - ./configs/server.dev.yaml:/etc/mxsec-platform/server.yaml:ro
      # 挂载证书
      - ./certs:/etc/mxsec-platform/certs:ro
      # Go 模块缓存
      - go_mod_cache:/go/pkg/mod
      - go_build_cache:/root/.cache/go-build
    working_dir: /workspace
    environment:
      - TZ=Asia/Shanghai
      - GO_ENV=development
    # 开发模式：优先使用 go run（简单可靠），如果 Air 可用则使用 Air
    command: >
      sh -c "
        cd /workspace &&
        # 确保 tmp 目录存在
        mkdir -p tmp &&
        # 先运行 go mod tidy 确保依赖正确
        go mod tidy &&
        if command -v air > /dev/null 2>&1 && [ -f .air.toml ]; then
          echo '使用 Air 热重载模式...';
          air -c .air.toml
        else
          echo '使用 go run 模式（修改代码后需要手动重启容器）...';
          go run ./cmd/server/manager -config /etc/mxsec-platform/server.yaml
        fi
      "
    networks:
      - mxsec-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    # 开发环境不需要资源限制
    # deploy:
    #   resources:
    #     limits:
    #       cpus: '2'
    #       memory: 2G

  ui:
    build:
      context: ../..
      dockerfile: deploy/docker/Dockerfile.ui.dev
    container_name: mxsec-ui-dev
    restart: unless-stopped
    # macOS Docker Desktop 不支持 host 网络模式，使用端口映射
    ports:
      - "3000:3000"
    volumes:
      # 挂载源代码，支持热重载
      - ../../ui:/app:rw
      - /app/node_modules
    working_dir: /app
    environment:
      - TZ=Asia/Shanghai
      - NODE_ENV=development
    networks:
      - mxsec-network
    # 开发模式：使用 vite dev server（支持热重载）
    command: ["npm", "run", "dev", "--", "--host", "0.0.0.0"]
    healthcheck:
      # 使用 0.0.0.0 而不是 localhost，因为 Vite 监听在 0.0.0.0
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://0.0.0.0:3000/"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s

  agent:
    build:
      context: ../..
      dockerfile: deploy/docker/Dockerfile.agent.dev
    container_name: mxsec-agent-dev
    restart: unless-stopped
    depends_on:
      agentcenter:
        condition: service_healthy
    volumes:
      # 挂载源代码，支持热重载（需要重新编译）
      - ../../:/workspace:rw
      - agent_data:/var/lib/mxsec-agent
      - agent_logs:/var/log/mxsec-agent
      - ./certs:/var/lib/mxsec-agent/certs:ro
      # Go 模块缓存
      - go_mod_cache:/go/pkg/mod
      - go_build_cache:/root/.cache/go-build
    working_dir: /workspace
    environment:
      - TZ=Asia/Shanghai
      - GO_ENV=development
      # Agent 构建时嵌入的配置（通过环境变量传递给 Air）
      - SERVER_HOST=agentcenter:6751
    # 开发模式：优先使用 Air（如果可用），否则使用 go run
    command: >
      sh -c "
        cd /workspace && 
        # 确保 tmp 目录存在
        mkdir -p tmp &&
        # 先运行 go mod tidy 确保依赖正确
        go mod tidy &&
        if command -v air > /dev/null 2>&1 && [ -f .air.agent.toml ]; then
          echo '使用 Air 热重载模式（Agent）...';
          echo 'SERVER_HOST=${SERVER_HOST}';
          echo 'VERSION=${VERSION}';
          air -c .air.agent.toml
        else
          echo '使用 go run 模式（修改代码后需要手动重启容器）...';
          go run -ldflags \"-X main.serverHost=${SERVER_HOST:-agentcenter:6751} -X main.buildVersion=${VERSION:-dev-test} -X main.buildTime=$(date -u +'%Y-%m-%dT%H:%M:%SZ')\" ./cmd/agent
        fi
      "
    networks:
      - mxsec-network
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 128M

volumes:
  agentcenter_logs:
    driver: local
  agent_data:
    driver: local
  agent_logs:
    driver: local
  go_mod_cache:
    driver: local
  go_build_cache:
    driver: local

networks:
  mxsec-network:
    driver: bridge
