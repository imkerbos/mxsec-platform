# 开发日志

> 本文件记录每日开发工作，用于 commit 时参考和总结。**此文件不提交到 GitHub**。

---

## 2025-12-10

### 任务：优化主机详情页面样式和数据展示

#### 完成的工作

1. **修复后端 API 返回数据结构**
   - 文件：`internal/server/manager/api/hosts.go`
   - 修改：将嵌套结构 `{host: {...}, baseline_results: [...]}` 扁平化为前端期望的 `HostDetail` 格式
   - 添加从 `host_metrics` 表查询 CPU 和内存使用率
   - 添加 `formatPercent` 和 `formatBytes` 格式化函数

2. **重新设计主机信息展示组件**
   - 文件：`ui/src/views/Hosts/components/HostOverview.vue`
   - 修改：使用自定义三列布局替代 `a-descriptions`，确保对齐
   - 优化：标签固定宽度（120px），右对齐；值左对齐，统一行高
   - 改进：空值显示从 "-" 改为 "未采集" 或 "未设置"，更友好
   - 样式：添加状态标签圆点效果，设备ID使用等宽字体

3. **扁平化安全态势概览和资产指纹区域**
   - 文件：`ui/src/views/Hosts/components/HostOverview.vue`
   - 修改：移除 Ant Design Card 组件，使用自定义扁平卡片
   - 移除：所有阴影效果（box-shadow）
   - 简化：使用 1px 边框替代卡片立体效果
   - 优化：使用 Grid 布局替代 Row/Col，统一间距

4. **优化整体样式**
   - 统一边框样式（1px solid #f0f0f0）
   - 统一圆角（2px）
   - 统一背景色和间距
   - 添加响应式设计支持

#### 修改的文件

- `internal/server/manager/api/hosts.go` - 扁平化 API 返回结构，添加监控数据查询
- `ui/src/views/Hosts/components/HostOverview.vue` - 重新设计布局和样式，扁平化设计

#### 技术要点

1. **API 数据结构扁平化**：
   - 后端返回直接匹配前端 `HostDetail` 接口
   - 从 `host_metrics` 表查询最新监控数据
   - 格式化百分比和字节数显示

2. **前端布局优化**：
   - 使用 flexbox 实现三列等宽布局
   - 固定标签宽度确保对齐
   - 自定义样式替代组件默认样式

3. **扁平化设计**：
   - 移除所有阴影和立体效果
   - 使用简单边框和背景色
   - 统一视觉风格

#### 待解决问题

- [ ] Agent 需要上报更多系统信息（device_model、manufacturer、cpu_info、memory_size 等）
- [ ] 需要从资产数据表查询并返回设备信息、CPU、内存等数据

#### Commit 建议

```bash
feat: 优化主机详情页面样式和数据展示

- 修复后端 API 返回数据结构，扁平化为前端期望格式
- 重新设计主机信息展示组件，优化对齐和布局
- 改进空值显示，使用更友好的占位符
- 扁平化安全态势概览和资产指纹区域
- 统一整体样式风格，添加响应式支持

相关文件：
- internal/server/manager/api/hosts.go
- ui/src/views/Hosts/components/HostOverview.vue
```

---

## 2025-01-XX（今天）

### 任务：修复 Agent 连接和证书下发流程

#### 完成的工作

1. **实现指数退避重试机制**
   - 文件：`internal/agent/transport/transport.go`
   - 修改：连接失败时使用指数退避（初始1秒，最大60秒），而非固定5秒延迟
   - 连接成功后重置重试计数和延迟

2. **添加详细的 Debug 日志**
   - Agent 端：
     - 连接重试日志（重试次数、延迟时间）
     - 数据发送/接收日志（记录数量、错误类型）
     - 证书包接收日志（证书大小）
     - 连接状态变化日志
   - Server 端：
     - Agent 连接日志（IP、版本信息）
     - 命令发送日志（证书包、配置、任务）
     - 数据接收日志（记录数量）
     - 连接断开日志（错误类型）

3. **实现 Server 端证书下发逻辑**
   - 文件：`internal/server/agentcenter/transfer/service.go`
   - 新增函数：`sendCertificateBundleIfNeeded()`
   - 功能：Agent 连接建立后立即下发证书包（CertificateBundle）
   - 读取 Server 端证书文件（CA、客户端证书、客户端密钥）并发送

4. **修复 Agent 首次连接无证书处理**
   - 文件：`internal/agent/connection/connection.go`
   - 问题：Agent 首次启动时证书文件不存在，导致连接失败
   - 修复：检查证书文件是否存在，如果不存在则使用 `InsecureSkipVerify: true` 建立首次连接
   - 流程：首次连接（不安全）→ Server 下发证书 → Agent 保存证书 → 后续连接使用正式证书

5. **完善证书保存逻辑**
   - 文件：`internal/agent/config/sync.go`
   - 修改：确保证书目录存在后再保存证书
   - 添加证书保存成功的提示日志

6. **编写文档**
   - 创建：`docs/design/certificate-distribution.md` - 证书下发流程说明
   - 创建：`docs/design/implementation-verification.md` - 实现流程符合性检查报告

#### 修改的文件

- `internal/agent/transport/transport.go` - 指数退避重试 + 详细日志
- `internal/agent/connection/connection.go` - 首次连接无证书处理
- `internal/agent/config/sync.go` - 证书保存时创建目录
- `internal/server/agentcenter/transfer/service.go` - 证书下发逻辑 + 详细日志
- `cmd/agent/main.go` - 证书更新日志
- `docs/design/certificate-distribution.md` - 新增文档
- `docs/design/implementation-verification.md` - 新增文档

#### 技术要点

1. **指数退避算法**：
   ```
   延迟 = min(初始延迟 * 2^(重试次数-1), 最大延迟)
   ```

2. **证书下发流程**：
   ```
   Agent 启动 → 检查证书 → 无证书则使用不安全模式连接 → 
   Server 下发证书包 → Agent 保存证书 → 后续连接使用正式证书
   ```

3. **首次连接安全**：
   - 使用 `InsecureSkipVerify: true` 仅用于首次连接获取证书
   - 连接建立后立即下发正式证书
   - 后续连接使用完整 mTLS 双向认证

#### 待解决问题

- [ ] 连接建立后立即断开的问题（需要进一步排查日志）
- [ ] 证书更新后是否需要主动重新连接（当前实现：下次重连时自动使用新证书）

#### Commit 建议

```bash
feat: 实现指数退避重试和证书自动下发机制

- 实现指数退避重试机制（初始1秒，最大60秒）
- 添加详细的 debug 日志（连接、数据发送/接收、证书处理）
- 实现 Server 端证书自动下发（首次连接时）
- 修复 Agent 首次连接无证书时的处理逻辑
- 完善证书保存和验证流程
- 添加证书下发流程文档

相关文件：
- internal/agent/transport/transport.go
- internal/agent/connection/connection.go
- internal/server/agentcenter/transfer/service.go
- docs/design/certificate-distribution.md
```

---

## 2025-12-10

### 任务：优化主机详情页面布局和功能

#### 完成的工作

1. **将设备ID移到页面顶部显示**
   - 文件：`ui/src/views/Hosts/Detail.vue`
   - 修改：在页面头部添加设备ID显示，包含"设备ID："标签和复制按钮
   - 原因：用户希望设备ID显示在更显眼的位置

2. **实现主机标签功能**
   - 文件：
     - `internal/server/model/host.go` - 添加 Tags 字段
     - `internal/server/manager/api/hosts.go` - 添加 UpdateHostTags API
     - `cmd/server/manager/main.go` - 注册标签更新路由
     - `ui/src/api/hosts.ts` - 添加 updateTags API 方法
     - `ui/src/api/types.ts` - 添加 tags 字段类型定义
     - `ui/src/views/Hosts/components/HostOverview.vue` - 添加标签显示和编辑功能
   - 修改：支持多标签编辑（最多10个，每个最多50字符），标签保存到数据库
   - 原因：用户需要为主机设置标签并保存到数据库

3. **优化所有字段的显示和交互**
   - 文件：`ui/src/views/Hosts/components/HostOverview.vue`
   - 修改：为所有字段添加悬停查看完整内容和点击复制功能
   - 原因：提升用户体验，方便复制字段内容

4. **改进硬件信息采集逻辑**
   - 文件：`internal/agent/heartbeat/heartbeat.go`
   - 修改：
     - 过滤无效值（如 "Not Specified", "To be filled by O.E.M." 等）
     - 添加降级方案：如果 DMI 文件读取失败，尝试使用 dmidecode 命令
   - 原因：提高设备型号、制造商、序列号的采集成功率

5. **修复CPU信息显示格式问题**
   - 文件：`ui/src/views/Hosts/components/HostOverview.vue`
   - 修改：CPU信息默认单行显示，超出部分用省略号，悬停显示完整内容
   - 原因：CPU信息过长导致格式错乱

6. **创建字段采集说明文档**
   - 文件：`docs/development/field-collection-notes.md`
   - 修改：新增文档，说明为什么某些字段可能显示为"未采集"
   - 原因：帮助用户理解字段采集机制

#### 修改的文件

- `internal/server/model/host.go` - 添加 Tags 字段到 Host 模型
- `internal/server/manager/api/hosts.go` - 添加 UpdateHostTags API 端点，在 GetHost 中返回 tags
- `cmd/server/manager/main.go` - 注册 PUT /api/v1/hosts/:host_id/tags 路由
- `internal/agent/heartbeat/heartbeat.go` - 改进硬件信息采集逻辑，添加 dmidecode 降级方案
- `ui/src/api/hosts.ts` - 添加 updateTags API 方法
- `ui/src/api/types.ts` - 添加 tags 字段到 Host 和 HostDetail 类型
- `ui/src/views/Hosts/Detail.vue` - 在页面头部添加设备ID显示和复制功能
- `ui/src/views/Hosts/components/HostOverview.vue` - 实现标签编辑功能，为所有字段添加悬停和复制功能
- `docs/development/field-collection-notes.md` - 新增字段采集说明文档

#### 技术要点

1. **主机标签功能**：
   - 使用 JSON 数组类型存储标签（StringArray）
   - 前端使用 a-select 的 tags 模式实现多标签输入
   - 后端验证标签数量（最多10个）和长度（每个最多50字符）

2. **可复制文本组件**：
   - 使用 a-tooltip 显示完整内容
   - 点击文本自动复制到剪贴板
   - 统一的视觉反馈（悬停变蓝、下划线、手型光标）

3. **硬件信息采集优化**：
   - 优先从 DMI 文件读取
   - 降级方案：使用 dmidecode 命令
   - 过滤无效值，避免显示无意义信息

4. **数据库迁移**：
   - Tags 字段会自动通过 Gorm AutoMigrate 添加
   - 重启 Server 后自动执行迁移

#### 待解决问题

- [ ] 容器环境中 device_model、manufacturer、device_serial 仍无法采集（这是容器隔离机制的正常表现）
- [ ] 考虑添加手动编辑这些字段的功能（类似标签功能）

#### Commit 建议

```bash
feat: 优化主机详情页面布局和功能

- 将设备ID移到页面顶部显示，添加复制功能
- 实现主机标签功能（前端UI + 后端API + 数据库）
- 为所有字段添加悬停查看完整内容和点击复制功能
- 改进硬件信息采集逻辑（过滤无效值，添加dmidecode降级方案）
- 修复CPU信息显示格式问题（单行显示，超出省略）
- 添加字段采集说明文档

相关文件：
- internal/server/model/host.go
- internal/server/manager/api/hosts.go
- internal/agent/heartbeat/heartbeat.go
- ui/src/views/Hosts/Detail.vue
- ui/src/views/Hosts/components/HostOverview.vue
- docs/development/field-collection-notes.md
```

---

## 模板：后续日期使用

```markdown
## YYYY-MM-DD

### 任务：[任务名称]

#### 完成的工作
1. [工作项1]
   - 文件：[文件路径]
   - 修改：[具体修改内容]
   - 原因：[为什么修改]

2. [工作项2]
   ...

#### 修改的文件
- [文件1] - [修改说明]
- [文件2] - [修改说明]

#### 技术要点
- [技术点1]
- [技术点2]

#### 待解决问题
- [ ] [问题1]
- [ ] [问题2]

#### Commit 建议
[建议的 commit 信息]
```
