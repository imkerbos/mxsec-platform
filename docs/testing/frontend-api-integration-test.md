# 前端 API 集成测试文档

本文档描述前端 API 集成的测试和验证方法。

## 快速开始

运行自动化测试脚本：

```bash
# 使用 curl 或 Postman 手动测试 API 端点
```

脚本会自动：
1. 登录获取认证 Token
2. 测试所有主要 API 端点
3. 输出测试结果汇总

如果所有测试通过，说明 API 集成正常工作。

## 测试范围

### 1. 主机管理 API

#### 1.1 主机监控数据 API (`GET /api/v1/hosts/:host_id/metrics`)

**测试场景：**
- ✅ API 调用已集成到 `PerformanceMonitor` 组件
- ✅ 支持时间范围查询参数（`start_time`, `end_time`）
- ✅ 自动查询最近1小时的监控数据

**验证步骤：**
1. 打开主机详情页
2. 切换到"性能监控"标签页
3. 验证是否显示：
   - CPU 使用率（带颜色指示：绿色<70%, 黄色70-90%, 红色>=90%）
   - 内存使用率
   - 磁盘使用率
   - 网络流量（发送/接收）
   - 数据源信息（MySQL 或 Prometheus）
   - 最后更新时间

**预期结果：**
- 如果后端返回数据，应正确显示监控指标
- 如果后端无数据，应显示"暂无监控数据"提示
- 加载状态应正确显示

#### 1.2 主机状态分布 API (`GET /api/v1/hosts/status-distribution`)

**测试场景：**
- ✅ API 调用已集成到 `Dashboard` 页面
- ✅ 并行加载，不影响主流程

**验证步骤：**
1. 打开 Dashboard 页面
2. 检查控制台是否有错误
3. 验证在线/离线 Agent 数量是否正确更新

**预期结果：**
- API 调用成功时，更新在线/离线 Agent 数量
- API 调用失败时，不影响 Dashboard 其他功能（使用 catch 处理）

#### 1.3 主机风险分布 API (`GET /api/v1/hosts/risk-distribution`)

**测试场景：**
- ✅ API 调用已集成到 `Dashboard` 页面
- ✅ 自动计算风险主机百分比

**验证步骤：**
1. 打开 Dashboard 页面
2. 查看"主机风险分布"卡片
3. 验证风险百分比是否正确计算

**预期结果：**
- 根据风险分布数据计算各类型风险的主机百分比
- 计算公式：`(风险主机数 / 总主机数) * 100`

### 2. 策略管理 API

#### 2.1 策略统计信息 API (`GET /api/v1/policies/:policy_id/statistics`)

**测试场景：**
- ✅ API 调用已集成到策略详情页
- ✅ 有回退机制（API 失败时使用手动计算）

**验证步骤：**
1. 打开策略详情页
2. 查看"基线检查概览"区域
3. 验证以下统计信息：
   - 最近检查通过率（圆形进度条）
   - 检查主机数（包含通过/未通过统计）
   - 检查项数（包含风险项/通过项统计）
   - 最近检查时间

**预期结果：**
- 如果 API 成功，使用 API 返回的统计数据
- 如果 API 失败，回退到手动计算方式（从检查结果列表计算）
- 所有统计数据应正确显示

### 3. 类型定义验证

**已定义的类型：**
- ✅ `HostMetrics` - 主机监控数据类型
- ✅ `LatestMetrics` - 最新监控数据
- ✅ `TimeSeriesMetrics` - 时间序列监控数据
- ✅ `TimeSeriesPoint` - 时间序列数据点
- ✅ `PolicyStatistics` - 策略统计信息类型
- ✅ `HostStatusDistribution` - 主机状态分布
- ✅ `HostRiskDistribution` - 主机风险分布

**验证方法：**
- 使用 TypeScript 编译器检查类型错误
- 运行 `npm run type-check`（如果配置了）

## 错误处理验证

### 1. API 调用失败处理

**测试场景：**
- 网络错误
- 后端服务不可用
- 返回错误状态码

**验证步骤：**
1. 模拟网络错误（断开网络或使用错误的 API 地址）
2. 检查组件是否正确处理错误
3. 验证是否有用户友好的错误提示

**预期结果：**
- 所有 API 调用都有 try-catch 错误处理
- 错误信息记录到控制台（开发环境）
- 用户看到友好的错误提示或空状态

### 2. 数据为空处理

**测试场景：**
- 后端返回空数据
- 某些字段缺失

**验证步骤：**
1. 检查组件是否正确处理空数据
2. 验证是否显示空状态提示

**预期结果：**
- 使用可选链操作符（`?.`）安全访问嵌套属性
- 显示空状态提示（如 `<a-empty>` 组件）

## 性能验证

### 1. 并行加载

**Dashboard 页面：**
- ✅ 使用 `Promise.all` 并行加载多个 API
- ✅ 减少页面加载时间

**验证步骤：**
1. 打开 Dashboard 页面
2. 检查网络请求是否并行发送
3. 测量页面加载时间

### 2. 数据缓存

**策略详情页：**
- ✅ 统计信息在策略加载时获取
- ✅ 避免重复请求

## 代码质量检查

### 1. TypeScript 类型检查

运行以下命令检查类型错误：

```bash
cd ui
npm run type-check  # 如果配置了
# 或
npx vue-tsc --noEmit
```

### 2. Linter 检查

运行以下命令检查代码规范：

```bash
cd ui
npm run lint
```

### 3. 代码审查清单

- [x] 所有 API 调用都有错误处理
- [x] 所有类型定义正确导入
- [x] 组件正确使用 API
- [x] 空数据状态正确处理
- [x] 加载状态正确显示
- [x] 用户友好的错误提示

## 自动化测试

### 使用测试脚本

可以使用 curl 或 Postman 手动测试所有 API 端点。

#### 基本使用

```bash
# 使用默认配置（admin/admin123）
# 使用 curl 或 Postman 手动测试 API 端点

# 自定义 API 地址和认证信息
export API_BASE_URL="http://localhost:8080/api/v1"
export USERNAME="admin"
export PASSWORD="admin123"
# 使用 curl 或 Postman 手动测试 API 端点

# 或直接提供 Token
export TOKEN="your-jwt-token"
# 使用 curl 或 Postman 手动测试 API 端点
```

#### 测试脚本功能

- ✅ 自动登录获取 Token
- ✅ 测试所有主要 API 端点
- ✅ 自动跳过需要认证但无 Token 的测试
- ✅ 友好的错误提示和测试结果汇总
- ✅ 支持自定义配置（环境变量）

#### 测试覆盖的 API

- 主机管理 API（列表、状态分布、风险分布、监控数据）
- 策略管理 API（列表、详情、统计信息）
- Dashboard API（统计数据）
- 检测结果 API（列表、主机得分、摘要）
- 资产数据 API（进程、端口、账户）

## 手动测试步骤

### 测试环境准备

1. 确保后端服务运行在 `http://localhost:8080`
2. 确保前端开发服务器运行在 `http://localhost:3000`
3. 确保有测试数据（主机、策略、检查结果等）
4. 确保后端服务正常运行且可访问

### 测试用例

#### 测试用例 1：主机详情页 - 性能监控

1. 打开浏览器，访问 `http://localhost:3000`
2. 登录系统
3. 进入"主机管理"页面
4. 点击任意主机，进入主机详情页
5. 切换到"性能监控"标签页
6. **验证点：**
   - [ ] 页面显示加载状态
   - [ ] 监控数据正确显示（CPU、内存、磁盘）
   - [ ] 数据源信息正确显示
   - [ ] 时间格式化正确

#### 测试用例 2：策略详情页 - 统计信息

1. 进入"策略管理"页面
2. 点击任意策略，进入策略详情页
3. **验证点：**
   - [ ] 检查概览区域显示统计数据
   - [ ] 通过率圆形进度条正确显示
   - [ ] 主机数和检查项数正确显示
   - [ ] 最近检查时间正确显示

#### 测试用例 3：Dashboard - 主机状态和风险分布

1. 进入 Dashboard 页面
2. **验证点：**
   - [ ] 页面正常加载，无错误
   - [ ] 主机状态分布数据正确（如果 API 可用）
   - [ ] 主机风险分布百分比正确计算
   - [ ] 即使 API 失败，其他功能正常

## 已知问题和限制

1. **时间序列图表**：`PerformanceMonitor` 组件中预留了图表位置，但图表功能待实现
2. **错误提示**：某些错误可能只记录到控制台，用户可能看不到明确的错误提示
3. **数据刷新**：部分页面没有自动刷新机制，需要手动刷新

## 后续改进建议

1. 添加单元测试（使用 Vitest）
2. 添加 E2E 测试（使用 Playwright 或 Cypress）
3. 实现时间序列图表（使用 ECharts 或 Chart.js）
4. 添加数据自动刷新机制
5. 改进错误提示，使用全局消息提示组件
